variant: flatcar
version: 1.1.0

ignition:
  version: 3.4.0

passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - ssh-rsa AAAAB3Nza...your_public_key
    - name: root
      password_hash: $6$hNh1nwO5OWWct4aZ$OoeAkQ4gKNBnGYK0ECi8saBMbUNeQRMICcOPYEu1bFuj9Axt4Rh6EnGba07xtIsGNt2wP9SsPlz543gfJww11/

storage:
  files:
    - path: /etc/hostname
      filesystem: "root"
      mode: 0644
      contents:
        inline: master1.cefaslocalserver.com
    - path: /home/core/install-oc.sh
      filesystem: "root"
      mode: 0755
      contents:
        inline: |
          #!/bin/bash
          set -euxo pipefail
          exec > /home/core/install-oc.log 2>&1

          echo "Starting OpenShift CLI installation"
          mkdir -p /opt/bin
          curl -L -o /tmp/openshift-client-linux.tar.gz https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz
          tar -xzf /tmp/openshift-client-linux.tar.gz -C /tmp
          sudo mv /tmp/oc /opt/bin/oc
          sudo chmod +x /opt/bin/oc
          sudo rm -rf /tmp/openshift-client-linux.tar.gz

          if [ -w /home/core/.bashrc ]; then
            echo 'export PATH=$PATH:/opt/bin' >> /home/core/.bashrc
            echo 'export KUBECONFIG=/home/core/okd-install/auth/kubeconfig' >> /home/core/.bashrc
          else
            echo "/home/core/.bashrc is not writable"
    - path: /home/core/install-kubelet.sh
      filesystem: "root"
      mode: 0755
      contents:
        inline: |
          #!/bin/bash
          set -euxo pipefail
          exec > /home/core/install-kubelet.log 2>&1

          echo "Starting kubelet installation"
          toolbox --bind=/etc:/host/etc --bind=/usr:/host/usr --bind=/opt:/host/opt --bind=/var:/host/var --bind=/run:/host/run /bin/bash -c '
            curl -L -o /tmp/kubelet.rpm https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/kubernetes/kubelet-1.20.0-0.1.20210118102551.fc32.x86_64.rpm
            sudo rpm -ivh /tmp/kubelet.rpm
            if [ -f /usr/bin/kubelet ]; then
              sudo systemctl enable kubelet
              sudo systemctl start kubelet
            else
              echo "Kubelet binary is not found, exiting"
              exit 1
            fi
          '

systemd:
  units:
    - name: apply-network-routes.service
      enabled: true
      contents: |
        [Unit]
        Description=Apply custom network routes
        After=network-online.target
        Wants=network-online.target

        [Service]
        Type=oneshot
        ExecStart=/usr/bin/systemctl restart systemd-networkd.service
        RemainAfterExit=true

        [Install]
        WantedBy=multi-user.target
    - name: set-hosts.service
      enabled: true
      contents: |
        [Unit]
        Description=Set /etc/hosts file
        After=network.target

        [Service]
        Type=oneshot
        ExecStart=/bin/bash -c 'echo "127.0.0.1   localhost" > /etc/hosts; echo "::1         localhost" >> /etc/hosts; echo "10.17.4.21  master1.cefaslocalserver.com master1" >> /etc/hosts'
        RemainAfterExit=true

        [Install]
        WantedBy=multi-user.target
    - name: install-oc.service
      enabled: true
      contents: |
        [Unit]
        Description=Install OpenShift CLI (oc)
        After=network-online.target
        Wants=network-online.target

        [Service]
        Type=oneshot
        ExecStart=/bin/bash /home/core/install-oc.sh
        RemainAfterExit=true

        [Install]
        WantedBy=multi-user.target
    - name: install-kubelet.service
      enabled: true
      contents: |
        [Unit]
        Description=Install and start kubelet
        After=network-online.target
        Wants=network-online.target

        [Service]
        Type=oneshot
        ExecStart=/bin/bash /home/core/install-kubelet.sh
        RemainAfterExit=true

        [Install]
        WantedBy=multi-user.target
    - name: kubelet.service
      enabled: true
      contents: |
        [Unit]
        Description=Kubelet
        Documentation=https://kubernetes.io/docs/
        After=network.target

        [Service]
        ExecStart=/usr/bin/kubelet
        Restart=always
        StartLimitInterval=0
        RestartSec=10

        [Install]
        WantedBy=multi-user.target