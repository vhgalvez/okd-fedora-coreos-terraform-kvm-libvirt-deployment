variant: flatcar
version: 1.1.0

ignition:
  version: 3.4.0

passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - "${ssh_keys}"
    - name: root
      password_hash: $6$hNh1nwO5OWWct4aZ$OoeAkQ4gKNBnGYK0ECi8saBMbUNeQRMICcOPYEu1bFuj9Axt4Rh6EnGba07xtIsGNt2wP9SsPlz543gfJww11/

storage:
  files:
    - path: /etc/hostname
      filesystem: "root"
      mode: 0644
      contents:
        inline: "${host_name}"
    - path: /home/core/works
      filesystem: "root"
      mode: 0755
      contents: 
        inline: |
          #!/bin/bash
          set -euo pipefail
          echo My name is ${name} and the hostname is ${host_name}
    - path: /etc/hosts
      filesystem: "root"
      mode: 0644
      contents:
        inline: |
          127.0.0.1   localhost
          ::1         localhost

          # Añade las entradas para todas las máquinas virtuales y el servidor físico
          10.17.3.11   freeipa1.cefaslocalserver.com   freeipa1
          10.17.3.12   loadbalancer1.cefaslocalserver.com   loadbalancer1
          10.17.3.13   postgresql1.cefaslocalserver.com   postgresql1

          10.17.4.20   bootstrap1.cefaslocalserver.com   bootstrap1
          10.17.4.21   master1.cefaslocalserver.com   master1
          10.17.4.22   master2.cefaslocalserver.com   master2
          10.17.4.23   master3.cefaslocalserver.com   master3
          10.17.4.24   worker1.cefaslocalserver.com   worker1
          10.17.4.25   worker2.cefaslocalserver.com   worker2
          10.17.4.26   worker3.cefaslocalserver.com   worker3

          # Entrada para el servidor bastion1
          192.168.0.20   bastion1.cefaslocalserver.com   bastion1

          # Entrada para el servidor físico
          192.168.0.21   physical1.cefaslocalserver.com   physical1
    - path: /etc/systemd/network/10-eth0.network
      filesystem: "root"
      mode: 0644
      contents:
        inline: |
          [Match]
          Name=eth0

          [Network]
          Address=${ip}/24
          Gateway=${gateway}
          DNS=${dns1}
          DNS=${dns2}

          [Route]
          Destination=0.0.0.0/0
          Gateway=${gateway}
          Metric=1024

          [Route]
          Destination=10.17.4.0/24
          Gateway=${gateway}
          Metric=1024

          [Route]
          Destination=10.17.3.0/24
          Gateway=${gateway}
          Metric=1024

          [Route]
          Destination=192.168.0.0/24
          Gateway=${gateway}
          Metric=1024

systemd:
  units:
    - name: apply-network-routes.service
      enabled: true
      contents: |
        [Unit]
        Description=Apply custom network routes
        After=network-online.target
        Wants=network-online.target

        [Service]
        Type=oneshot
        ExecStart=/usr/bin/systemctl restart systemd-networkd.service
        RemainAfterExit=true

        [Install]
        WantedBy=multi-user.target
